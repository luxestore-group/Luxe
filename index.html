<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Luxe Store - Christmas Sale</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">

<style>
/* CSS STYLES */
:root{--gold:#b8860b;--silver:#c0c0c0; --green:#2ecc71; --red:#e74c3c;}
*{box-sizing:border-box;margin:0;padding:0;font-family:Arial,sans-serif;}
body{background:#fff8f0;color:#333;transition:.3s}
body.dark{background:#111;color:#fff}
header{background:linear-gradient(90deg,var(--gold),#fff,var(--silver));padding:14px;text-align:center;position:sticky;top:0;z-index:50; display: flex; justify-content: space-between; align-items: center; flex-direction: row;}
body.dark header{background:linear-gradient(90deg,#444,#666,#999)}
.header-logo {height: 40px; width: 40px; margin-right: 10px;}
.header-content { flex-grow: 1; text-align: center; display: flex; align-items: center; justify-content: center; flex-direction: column;} 
.header-content h1{font-size:1.8rem;font-family: 'Playfair Display', serif; font-weight: 700;}
.welcome-message { font-size: 0.9rem; margin-top: 4px; color: #555; font-family: 'Playfair Display', serif; font-style: italic;}
body.dark .welcome-message { color: #ccc; }
.products{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;padding:16px}
.card{background:#fff;border-radius:14px;box-shadow:0 4px 12px rgba(0,0,0,.2);overflow:hidden;transition:.3s; position: relative;}
body.dark .card{background:#222}
.card img{width:100%;height:180px;object-fit:cover; cursor: pointer;} 
.card-body{text-align:center;padding:10px}
.price{font-weight:bold;color:var(--silver)}

/* NEW STOCK STYLES */
.stock-display { font-size: 0.85rem; margin: 5px 0; font-weight: bold; }
.in-stock { color: var(--green); }
.low-stock { color: #f39c12; }
.out-of-stock { color: var(--red); }

.buttons{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
.buttons button{flex:1 1 45%;padding:8px;border:none;border-radius:10px;font-weight:bold;cursor:pointer}
.buy{background:var(--gold);color:#fff}
.buy:disabled { background: #ccc; cursor: not-allowed; } /* Style for Sold Out button */
.details{background:#c0c0c0}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);align-items:center;justify-content:center;z-index:1000}
.modal.show{display:flex}
.modal-box{background:#fff;color:#000;padding:16px;border-radius:14px;max-width:560px;width:95%;max-height:90vh;overflow:auto;position:relative}
body.dark .modal-box{background:#222;color:#fff}
.close{position:absolute;right:12px;top:8px;font-size:20px;cursor:pointer}
#imageViewerModal .modal-box {max-width: 95%;width: 95%;height: 95vh;padding: 0;background: transparent;box-shadow: none;display: flex;flex-direction: column;justify-content: center;align-items: center;border-radius: 0;}
#imageViewerContent {position: relative;max-width: 100%;max-height: 100%;display: flex;justify-content: center;align-items: center;overflow: hidden; }
#largeProductImage {max-width: 100%;max-height: 90vh;object-fit: contain;transition: transform 0.3s ease-in-out;cursor: zoom-in;transform-origin: center center;}
#largeProductImage.zoomed {transform: scale(2); cursor: zoom-out;max-width: none;}
.viewer-nav {position: absolute;top: 50%;transform: translateY(-50%);background: rgba(0,0,0,0.5);color: white;border: none;padding: 10px 15px;cursor: pointer;font-size: 28px;z-index: 10;transition: background 0.3s;border-radius: 50%;width: 50px;height: 50px;line-height: 28px;text-align: center;}
.viewer-nav:hover { background: rgba(0,0,0,0.8); }
#viewerPrev { left: 10px; }
#viewerNext { right: 10px; }
#viewerClose {position: absolute;top: 10px;right: 10px;background: rgba(0,0,0,0.5);color: white;border-radius: 50%;width: 30px;height: 30px;line-height: 30px;text-align: center;font-size: 20px;cursor: pointer;z-index: 100;}
#imageViewerModal.show #imageViewerContent {overflow: auto;}
#detailsModal .modal-box {max-width: 400px;height: auto;max-height: 90vh;overflow-y: auto;padding: 20px;}
#detailsModal p {margin-bottom: 15px;}
.cart-item{display:flex;justify-content:space-between;align-items:center;margin:6px 0}
.cart-item button{padding:4px 8px}
.notice{font-size:.9rem;line-height:1.4}
.notice ul{padding-left:18px}
.notice li{margin-bottom:6px}
.pay{background:var(--gold);color:#fff;padding:10px;border:none;border-radius:10px;width:100%;font-weight:bold;cursor:pointer}
.pay:disabled {background: #ccc; cursor: not-allowed;}
input, select{width:100%;padding:8px;margin:6px 0;border-radius:8px;border:1px solid #ccc}
.mtn-card img{background:#ffd700;padding:14px;object-fit:contain}
.mtn-bundles{display:grid;grid-template-columns:repeat(auto-fit,minmax(80px,1fr));gap:8px;margin-top:10px}
.mtn-bundles button{padding:8px;border:none;border-radius:10px;background:var(--gold);color:#fff;cursor:pointer}
.mtn-bundles button.selected{background:#ff9900;color:#000;font-weight:bold}
#menuBtn { background: none; border: none; font-size: 24px; cursor: pointer; padding: 0; margin-right: 15px; }
#sideMenu {position: fixed;top: 0;left: 0;width: 250px; height: 100%;background: #fff;color: #333;z-index: 2000;box-shadow: 2px 0 10px rgba(0,0,0,0.5);transform: translateX(-100%);transition: transform 0.3s ease-in-out;padding: 20px;display: flex;flex-direction: column;gap: 15px;box-sizing: border-box; border-top-right-radius: 14px; border-bottom-right-radius: 14px; }
body.dark #sideMenu { background: #222; color: #fff; }
#sideMenu.open { transform: translateX(0); }
#sideMenu button {padding: 12px;border-radius: 8px;border: none;font-weight: bold;cursor: pointer;text-align: left;width: 100%; box-sizing: border-box; background: var(--silver); color: #333;}
body.dark #sideMenu button { background: #444; color: #fff; }
#sideMenu #cartBtn_menu, #sideMenu #orderBtn_menu, #sideMenu #logoutBtn_menu { background: var(--gold); color: #fff; }
#sideMenu #supportBtn_menu { background: #c0c0c0; color: #333; }
body.dark #sideMenu #supportBtn_menu { background: #444; color: #fff; }
#menuOverlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.5); z-index: 1999; cursor: pointer; }
</style>
</head>
<body>

<div class="modal show" id="authModal">
  <div class="modal-box" style="text-align: center; max-width: 400px;">
    <h2>Welcome to Luxe Store</h2>
    <p>Please Sign In or Sign Up to access the store.</p>
    <input id="authEmail" type="email" placeholder="Email">
    <input id="authPassword" type="password" placeholder="Password">
    <button class="pay" id="signInBtn" style="margin-top: 15px;">Sign In</button>
    <button class="details" id="signUpBtn" style="margin-top: 8px;">Sign Up</button>
    <p id="authError" style="color: red; margin-top: 10px;"></p>
  </div>
</div>

<div id="sideMenu">
    <h3>Menu</h3>
    <button id="cartBtn_menu">ðŸ›’ Cart</button>
    <button id="orderBtn_menu">ðŸ’¬ Confirm Order</button>
    <button id="themeBtn_menu">Light / Dark</button>
    <button id="notifyBtn_menu">ðŸ”” Notice</button>
    <button id="supportBtn_menu">ðŸ“ž Customer Service</button> 
    <button id="whatsappGroupBtn_menu" style="background: #25d366; color: white;">ðŸ‘¥ WhatsApp Group</button>
    <button id="logoutBtn_menu" style="display: none;">Log Out</button>
</div>
<div id="menuOverlay"></div>

<header>
    <button id="menuBtn">â˜°</button> 
    <div class="header-content"> 
        <img src="images/luxe_logo.png" alt="Luxe Store Logo" class="header-logo"> 
        <h1>Luxe Store</h1>
        <p class="welcome-message" style="color: red; font-weight: bold;">ðŸŽ„ Christmas Flash Sale! 5% OFF Everything! ðŸŽ„</p>
    </div>
    <div style="width: 24px; margin-right: 15px;"></div> 
</header>

<div class="products">
    <div class="card" id="card_blender" data-id="blender" data-name="Silver Crest Blender 2in1 2.0L" data-price="285" data-images="images/blender.jpg,images/blenders.jpg,images/blender2.jpg" data-description="Powerful 2.0L blender with stainless steel blades.">
        <img src="images/blender.jpg" data-product-index="0">
        <div class="card-body">
            <h3>Silver Crest Blender 2-in1- 2.0L</h3>
            <p class="price"><span style="text-decoration: line-through; color: #888; font-size: 0.9em; margin-right: 5px;">â‚µ300</span> â‚µ285</p>
            <p class="stock-display" id="stock_blender">Checking stock...</p>
            <div class="buttons"><button class="buy" id="btn_blender">Add to Cart</button><button class="details">More Details</button></div>
        </div>
    </div>
    
    <div class="card" id="card_earphones" data-id="earphones" data-name="Superbass 2-in-1 Earphones" data-price="61.75" data-images="images/headphones.jpg,images/headphones1.jpg" data-description="High-fidelity audio with deep bass.">
        <img src="images/headphones.jpg" data-product-index="1">
        <div class="card-body">
            <h3>Superbass 2-in-1 Earphones</h3>
            <p class="price"><span style="text-decoration: line-through; color: #888; font-size: 0.9em; margin-right: 5px;">â‚µ65</span> â‚µ61.75</p>
            <p class="stock-display" id="stock_earphones">Checking stock...</p>
            <div class="buttons"><button class="buy" id="btn_earphones">Add to Cart</button><button class="details">More Details</button></div>
        </div>
    </div>
    
    <div class="card" id="card_watch" data-id="watch" data-name="Rich Ripple Smart Watch" data-price="190" data-images="images/smartwatch.jpg,images/smartwatch1.jpg" data-description="Sleek smart watch with a vibrant display.">
        <img src="images/smartwatch.jpg" data-product-index="2">
        <div class="card-body">
            <h3>Rich Ripple Smart Watch</h3>
            <p class="price"><span style="text-decoration: line-through; color: #888; font-size: 0.9em; margin-right: 5px;">â‚µ200</span> â‚µ190</p>
            <p class="stock-display" id="stock_watch">Checking stock...</p>
            <div class="buttons"><button class="buy" id="btn_watch">Add to Cart</button><button class="details">More Details</button></div>
        </div>
    </div>
    
    <div class="card" id="card_cable" data-id="cable" data-name="3-in-1 60W USB Cable" data-price="47.5" data-images="images/accessories.jpg,images/accessories1.jpg" data-description="Durable, braided cable with 60W fast charging.">
        <img src="images/accessories.jpg" data-product-index="3">
        <div class="card-body">
            <h3>3-in-1 60W USB Cable</h3>
            <p class="price"><span style="text-decoration: line-through; color: #888; font-size: 0.9em; margin-right: 5px;">â‚µ50</span> â‚µ47.50</p>
            <p class="stock-display" id="stock_cable">Checking stock...</p>
            <div class="buttons"><button class="buy" id="btn_cable">Add to Cart</button><button class="details">More Details</button></div>
        </div>
    </div>
    
    <div class="card" id="card_powerbank" data-id="powerbank" data-name="Oraimo Traveler Powerbank 10000mAh" data-price="190" data-images="images/powerbank.jpg,images/powerbank1.jpg" data-description="Compact 10,000mAh powerbank.">
        <img src="images/powerbank.jpg" data-product-index="4">
        <div class="card-body">
            <h3>Oraimo Traveler Powerbank</h3>
            <p class="price"><span style="text-decoration: line-through; color: #888; font-size: 0.9em; margin-right: 5px;">â‚µ200</span> â‚µ190</p>
            <p class="stock-display" id="stock_powerbank">Checking stock...</p>
            <div class="buttons"><button class="buy" id="btn_powerbank">Add to Cart</button><button class="details">More Details</button></div>
        </div>
    </div>

    <div class="card mtn-card" data-name="MTN Data Bundles" data-price="0" data-images="images/databundles.jpg" data-description="Instant MTN data top-ups.">
        <img src="images/databundles.jpg" data-product-index="5">
        <div class="card-body">
            <h3>MTN Data Bundles</h3>
            <p class="price">â‚µ5.50 â€“ â‚µ60.00</p>
            <div class="buttons"><button class="buy" id="mtnOpenBtn">Buy Bundle</button><button class="details" id="mtnDetailsBtn">More Details</button></div>
        </div>
    </div>
</div>

<div class="modal" id="cartModal">
<div class="modal-box">
<span class="close">Ã—</span>
<h3>Your Cart</h3>
<div id="cartItems"></div>
<p><strong>Total:</strong> â‚µ<span id="cartTotal">0</span></p>
<input id="custName" placeholder="Your name">
<input id="custPhone" placeholder="Phone number">
<input id="custEmail" placeholder="Email">
<button class="pay" id="checkoutBtn">Checkout & Pay</button>
</div>
</div>

<div class="modal" id="detailsModal">
    <div class="modal-box">
        <span class="close">Ã—</span>
        <h3 id="detailsTitle"></h3>
        <p id="detailsDescription"></p>
        <p><strong>Delivery:</strong> Takes 14-21 business days of delivery time for all products except for databundles take note!!</p>
    </div>
</div>

<div class="modal" id="imageViewerModal">
    <div class="modal-box">
        <span id="viewerClose">Ã—</span>
        <div id="imageViewerContent">
            <button id="viewerPrev" class="viewer-nav">&#10094;</button>
            <img id="largeProductImage" src="">
            <button id="viewerNext" class="viewer-nav">&#10095;</button>
        </div>
        <div style="color: white; margin-top: 10px;">Tap or click image to zoom/unzoom.</div>
    </div>
</div>

<div class="modal" id="mtnModal">
<div class="modal-box">
<span class="close">Ã—</span>
<h3>MTN Data Bundles</h3>
<p>Select a bundle and enter your MTN number:</p>
<div class="mtn-bundles">
<button data-price="5.5">1GB â€“ â‚µ5.50</button>
<button data-price="12">2GB â€“ â‚µ12</button>
<button data-price="18">3GB â€“ â‚µ18</button>
<button data-price="24">4GB â€“ â‚µ24</button>
<button data-price="30">5GB â€“ â‚µ30</button>
<button data-price="36">6GB â€“ â‚µ36</button>
<button data-price="42">7GB â€“ â‚µ42</button>
<button data-price="48">8GB â€“ â‚µ48</button>
<button data-price="54">9GB â€“ â‚µ54</button>
<button data-price="60">10GB â€“ â‚µ60</button> </div>
<input id="mtnNumber" placeholder="MTN Number (e.g. 054xxxxxxx)">
<input id="mtnName" placeholder="Your name">
<input id="mtnEmail" placeholder="Email">
<button class="pay" id="mtnPay">Pay for Bundle</button>
</div>
</div>

<div class="modal" id="noticeModal">
<div class="modal-box">
<span class="close">Ã—</span>
<h3>Must Read Before Purchase</h3>
<div class="notice">
<ul>
<li>All products are ready for delivery.</li>
<li>Users must provide correct info before and after payment.</li>
<li>TURBONET / BROADBAND SIMs do not work for this type of data bundles.</li>
<li>Purchase for wrong numbers are non-refundable.</li>
<li>Data bundle delivery: 30 mins â€“ 1 hr(2hrs max) for only Databundles.</li>
</ul>
</div>
</div>
</div>

<script type="module">
// --- GLOBAL CONFIGURATION ---
const PAYSTACK_PUBLIC_KEY = 'pk_live_98575428080557d261e91cb92fe745f878fc4278';
const CUSTOMER_SERVICE_NUMBER = '233548164533'; 
const DEFAULT_USER_EMAIL = 'jbellingham771@gmail.com'; 
const WHATSAPP_GROUP_LINK = 'https://chat.whatsapp.com/GxS4tPlo8sqH8xkbARNvPc';

// --- INVENTORY MANAGEMENT (CHANGE NUMBERS HERE TO UPDATE STOCK) ---
// If you want to change stock, change the number here and refresh the page.
const STORE_INVENTORY = {
    'blender': 20,
    'earphones': 50,
    'watch': 15,
    'cable': 100,
    'powerbank': 12
};

let cart = [];
let allProductsData = []; 
let currentStockState = {}; // Keeps track of live stock
let PaystackPop; 

function loadPaystackScript() {
    return new Promise((resolve, reject) => {
        if (window.PaystackPop) { PaystackPop = window.PaystackPop; resolve(PaystackPop); return; }
        const script = document.createElement('script');
        script.src = 'https://js.paystack.co/v1/inline.js';
        script.onload = () => { if (window.PaystackPop) { PaystackPop = window.PaystackPop; resolve(PaystackPop); } else { reject(new Error('Paystack Error')); } };
        script.onerror = () => reject(new Error('Network Error'));
        document.head.appendChild(script);
    });
}

// --- FIREBASE SETUP ---
let app, db, auth;
let firebaseInitialized = false;

async function initializeFirebase() {
    try {
        const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js");
        const { getFirestore, collection, addDoc, doc, setDoc, getDoc, updateDoc, increment, onSnapshot, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js");
        const { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } = await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js"); 

       const firebaseConfig = {
          apiKey: "AIzaSyA6WtaQD8tqriy9_WIBV3DxV9vcKzvNSdI",
          authDomain: "luxe-datastore.firebaseapp.com",
          databaseURL: "https://luxe-datastore-default-rtdb.firebaseio.com",
          projectId: "luxe-datastore",
          storageBucket: "luxe-datastore.firebasestorage.app",
          messagingSenderId: "337992102686",
          appId: "1:337992102686:web:91b6d6802686bf688b4f0f"
        }; 

        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app); 
        firebaseInitialized = true;

        // Auth Listeners
        const authModal = document.getElementById('authModal');
        const logoutBtnMenu = document.getElementById('logoutBtn_menu'); 
        
        onAuthStateChanged(auth, (user) => {
            if (user) {
                authModal.classList.remove('show');
                logoutBtnMenu.style.display = 'block'; 
                if(document.getElementById('custEmail')) document.getElementById('custEmail').value = user.email;
                if(document.getElementById('mtnEmail')) document.getElementById('mtnEmail').value = user.email;
            } else {
                authModal.classList.add('show');
                logoutBtnMenu.style.display = 'none'; 
                if(document.getElementById('custEmail')) document.getElementById('custEmail').value = DEFAULT_USER_EMAIL;
                if(document.getElementById('mtnEmail')) document.getElementById('mtnEmail').value = DEFAULT_USER_EMAIL;
            }
        });

        document.getElementById('signUpBtn').onclick = async () => {
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            const err = document.getElementById('authError'); err.textContent = '';
            if (!email || password.length < 6) { err.textContent = 'Email and a password of at least 6 characters are required.'; return; }
            try { await createUserWithEmailAndPassword(auth, email, password); } catch (e) { err.textContent = e.message.replace('Firebase: Error ', ''); }
        };

        document.getElementById('signInBtn').onclick = async () => {
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            const err = document.getElementById('authError'); err.textContent = '';
            try { await signInWithEmailAndPassword(auth, email, password); } catch (e) { err.textContent = 'Sign-in failed. Check email or password.'; }
        };

        document.getElementById('logoutBtn_menu').onclick = async () => {
            try { await signOut(auth); document.getElementById('sideMenu').classList.remove('open'); document.getElementById('menuOverlay').style.display = 'none'; } catch (e) { console.error(e); }
        };
        
        // --- REAL TIME STOCK LOGIC ---
        // 1. Initialize Stock if needed
        const stockRef = collection(db, 'inventory');
        for (const [key, qty] of Object.entries(STORE_INVENTORY)) {
            const docRef = doc(db, 'inventory', key);
            getDoc(docRef).then((snap) => {
                if (!snap.exists()) {
                    setDoc(docRef, { qty: qty }); // Create initial stock
                }
            });
        }

        // 2. Listen for changes and update UI
        onSnapshot(collection(db, 'inventory'), (snapshot) => {
            snapshot.forEach((doc) => {
                const data = doc.data();
                const productId = doc.id;
                const qty = data.qty;
                currentStockState[productId] = qty; // Save for logic

                // Update UI Text
                const displayEl = document.getElementById(`stock_${productId}`);
                const btnEl = document.getElementById(`btn_${productId}`);
                
                if (displayEl) {
                    if (qty > 10) {
                        displayEl.innerHTML = `<span class="in-stock">In Stock: ${qty} items left</span>`;
                        displayEl.className = 'stock-display';
                    } else if (qty > 0) {
                        displayEl.innerHTML = `<span class="low-stock">Hurry! Only ${qty} left!</span>`;
                        displayEl.className = 'stock-display';
                    } else {
                        displayEl.innerHTML = `<span class="out-of-stock">Sold Out</span>`;
                    }
                }

                // Disable button if sold out
                if (btnEl) {
                    if (qty <= 0) {
                        btnEl.disabled = true;
                        btnEl.textContent = "Sold Out";
                        btnEl.style.backgroundColor = "#ccc";
                    } else {
                        btnEl.disabled = false;
                        btnEl.textContent = "Add to Cart";
                        btnEl.style.backgroundColor = ""; // Reset to CSS default
                    }
                }
            });
        });

        return { collection, addDoc, doc, updateDoc, increment, serverTimestamp, auth, db };

    } catch (error) {
        console.error("Firebase Error:", error);
        return false; 
    }
}

const firebaseModulesPromise = initializeFirebase();

// --- DOM HANDLERS ---
document.addEventListener('DOMContentLoaded', () => {
    initializeDOMHandlers(firebaseModulesPromise);
});

function initializeDOMHandlers(firebaseModulesPromise) {
    
    document.querySelectorAll('.card').forEach((card, index) => {
        allProductsData.push({
            index: index,
            id: card.dataset.id, // Capture the ID
            name: card.dataset.name,
            images: card.dataset.images.split(',').filter(s => s.trim() !== ''),
            description: card.dataset.description
        });
    });

    const sideMenu = document.getElementById('sideMenu');
    const menuOverlay = document.getElementById('menuOverlay');
    const toggleMenu = () => { sideMenu.classList.toggle('open'); menuOverlay.style.display = sideMenu.classList.contains('open') ? 'block' : 'none'; };
    document.getElementById('menuBtn').onclick = toggleMenu;
    menuOverlay.onclick = toggleMenu; 
    document.getElementById('cartBtn_menu').onclick = () => { document.getElementById('cartModal').classList.add('show'); toggleMenu(); };
    document.getElementById('orderBtn_menu').onclick = () => { document.getElementById('orderBtn_handler').click(); toggleMenu(); };
    document.getElementById('themeBtn_menu').onclick = () => { document.body.classList.toggle('dark'); };
    document.getElementById('notifyBtn_menu').onclick = () => { document.getElementById('noticeModal').classList.add('show'); toggleMenu(); };
    document.getElementById('supportBtn_menu').onclick = () => { window.open(`https://wa.me/${CUSTOMER_SERVICE_NUMBER}?text=Hello Luxe Store Customer Service`, '_blank'); toggleMenu(); };
    document.getElementById('whatsappGroupBtn_menu').onclick = () => { window.open(WHATSAPP_GROUP_LINK, '_blank'); toggleMenu(); };

    document.querySelectorAll('.close, #viewerClose').forEach(c => c.onclick = () => document.querySelectorAll('.modal').forEach(m => m.classList.remove('show')));

    const cartItems=document.getElementById('cartItems');
    const cartTotal=document.getElementById('cartTotal');
    function renderCart(){
      cartItems.innerHTML=''; let total=0;
      cart.forEach((i,idx)=>{
        total+=i.price*i.qty;
        const div=document.createElement('div');
        div.className='cart-item';
        div.innerHTML=`${i.name} x${i.qty} `;
        const plus=document.createElement('button'); plus.textContent='+'; 
        plus.onclick=()=>{
            // Check stock before adding more
            if(i.id && currentStockState[i.id] && i.qty >= currentStockState[i.id]) {
                alert(`Sorry, only ${currentStockState[i.id]} left in stock!`);
                return;
            }
            i.qty++; renderCart();
        };
        const minus=document.createElement('button'); minus.textContent='-'; minus.onclick=()=>{i.qty>1?i.qty--:cart.splice(idx,1); renderCart();};
        div.appendChild(plus); div.appendChild(minus);
        cartItems.appendChild(div);
      });
      cartTotal.textContent=total;
    }

    const imageViewerModal = document.getElementById('imageViewerModal');
    const largeProductImage = document.getElementById('largeProductImage');
    const viewerPrev = document.getElementById('viewerPrev');
    const viewerNext = document.getElementById('viewerNext');
    let currentViewerImages = [], currentViewerIndex = 0;

    function updateImageViewer() {
        largeProductImage.src = currentViewerImages[currentViewerIndex];
        largeProductImage.classList.remove('zoomed'); 
        viewerPrev.style.display = currentViewerImages.length > 1 ? 'block' : 'none';
        viewerNext.style.display = currentViewerImages.length > 1 ? 'block' : 'none';
    }
    viewerPrev.onclick = () => { if(currentViewerIndex > 0) currentViewerIndex--; updateImageViewer(); };
    viewerNext.onclick = () => { if(currentViewerIndex < currentViewerImages.length - 1) currentViewerIndex++; updateImageViewer(); };
    largeProductImage.onclick = () => { largeProductImage.classList.toggle('zoomed'); };

    document.querySelectorAll('.card').forEach(card=>{
      const name=card.dataset.name;
      const prodId=card.dataset.id; // Get ID
      const description = card.dataset.description;
      const productIndex = Number(card.querySelector('img').dataset.productIndex); 
      
      card.querySelector('img').onclick = () => {
          if(allProductsData[productIndex]) {
             currentViewerImages = allProductsData[productIndex].images;
             currentViewerIndex = 0;
             updateImageViewer();
             imageViewerModal.classList.add('show');
          }
      };
      
      if(card.querySelector('.buy') && !card.classList.contains('mtn-card')){
        card.querySelector('.buy').onclick=()=>{
          // Initial Stock Check
          if(prodId && currentStockState[prodId] <= 0) {
              alert("Sorry, this item is sold out.");
              return;
          }

          let item = cart.find(i => i.name === name);
          if (item) {
              if(prodId && currentStockState[prodId] && item.qty >= currentStockState[prodId]) {
                  alert(`Sorry, only ${currentStockState[prodId]} left!`);
                  return;
              }
              item.qty++; 
          } else {
              cart.push({name, id: prodId, price:Number(card.dataset.price||0),qty:1});
          }
          renderCart();
          document.getElementById('cartModal').classList.add('show');
        };
      }
      if(card.querySelector('.details')){
        card.querySelector('.details').onclick=()=>{
          document.getElementById('detailsTitle').textContent=name;
          document.getElementById('detailsDescription').textContent=description; 
          document.getElementById('detailsModal').classList.add('show');
        };
      }
    });

    function generateOrderId(type="ORD"){
      const d=new Date();
      return `${type}-${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}-${Math.floor(Math.random()*900+100)}`;
    }

    async function handlePayment(email, amount, orderId, metadata, onSuccessCallback, btn) {
        const originalText = btn.textContent;
        btn.textContent = "Processing...";
        btn.disabled = true;

        if (typeof onSuccessCallback !== 'function') {
            alert("System Error. Reload page."); btn.textContent = originalText; btn.disabled = false; return;
        }

        try {
            const paystackPop = await loadPaystackScript();
            const handler = paystackPop.setup({
                key: PAYSTACK_PUBLIC_KEY, email: email, amount: amount * 100, currency: 'GHS', ref: orderId, metadata: metadata,
                callback: (response) => { onSuccessCallback(response); },
                onClose: () => { btn.textContent = originalText; btn.disabled = false; },
                onError: (err) => { alert('Payment Initialization Failed.'); btn.textContent = originalText; btn.disabled = false; }
            });
            handler.openIframe(); 
        } catch (error) {
            alert(`Payment setup failed: ${error.message}`); btn.textContent = originalText; btn.disabled = false;
        }
    }

    document.getElementById('checkoutBtn').onclick = async function() {
        const btn = this;
        const modules = await firebaseModulesPromise;

        if(!modules || !modules.auth.currentUser){ alert('Please Sign In first.'); return; } 
        if(cart.length===0){alert('Cart empty!'); return;}
        
        // FINAL STOCK CHECK BEFORE PAYMENT
        let stockIssue = false;
        cart.forEach(item => {
            if (item.id && currentStockState[item.id] < item.qty) {
                alert(`Stock changed! We only have ${currentStockState[item.id]} of ${item.name} left.`);
                stockIssue = true;
            }
        });
        if(stockIssue) return;

        const name=document.getElementById('custName').value.trim();
        const phone=document.getElementById('custPhone').value.trim();
        const email=document.getElementById('custEmail').value.trim();
        const total=Number(cartTotal.textContent);
        
        if(!name||!phone||!email){alert('Please fill all details.'); return;}

        const orderId = generateOrderId("ORD");
        const userId = modules.auth.currentUser.uid;

        const successHandler = async (res) => {
            try {
                // 1. Record Order
                await modules.addDoc(modules.collection(modules.db,'orders'),{
                    orderId, userId, customerName:name, customerPhone:phone, customerEmail:email,
                    items:cart, totalAmount:total, status:'Paid', reference:res.reference, timestamp:modules.serverTimestamp()
                });

                // 2. DECREMENT STOCK
                for (const item of cart) {
                    if (item.id) {
                        const itemRef = modules.doc(modules.db, 'inventory', item.id);
                        await modules.updateDoc(itemRef, {
                            qty: modules.increment(-item.qty)
                        });
                    }
                }

                alert('Payment successful! Order ID: '+orderId);
                cart=[]; renderCart(); document.getElementById('cartModal').classList.remove('show');
            } catch(e) { console.error(e); alert('Payment successful but order logging failed. Contact support.'); }
        };

        await handlePayment(email, total, orderId, {}, successHandler, btn);
    };

    let selectedMTNPrice=5.5, selectedMTNBundle="1GB";
    document.querySelector('.mtn-bundles button').classList.add('selected');
    document.querySelectorAll('.mtn-bundles button').forEach(btn=>{
      btn.onclick=()=>{
        document.querySelectorAll('.mtn-bundles button').forEach(b=>b.classList.remove('selected'));
        btn.classList.add('selected');
        selectedMTNPrice=Number(btn.dataset.price);
        selectedMTNBundle=btn.textContent.split('â€“')[0].trim();
      };
    });
    document.getElementById('mtnOpenBtn').onclick=()=>document.getElementById('mtnModal').classList.add('show');

    document.getElementById('mtnPay').onclick = async function() {
        const btn = this;
        const modules = await firebaseModulesPromise;
        if(!modules || !modules.auth.currentUser){ alert('Please Sign In first.'); return; } 
        const number=document.getElementById('mtnNumber').value.trim();
        const name=document.getElementById('mtnName').value.trim();
        const email=document.getElementById('mtnEmail').value.trim();
        if(!number||!name||!email){alert('Please fill all details.'); return;}
        if(number.length !== 10){alert('Invalid 10-digit MTN number (e.g., 054xxxxxxx).'); return;}

        const orderId = generateOrderId("MTN");
        const userId = modules.auth.currentUser.uid;

        const successHandler = async (res) => {
            try {
                await modules.addDoc(modules.collection(modules.db,'mtn_orders'),{
                    orderId, userId, customerName:name, customerPhone:number, customerEmail:email,
                    bundle:selectedMTNBundle, amount:selectedMTNPrice, status:'Paid', reference:res.reference, timestamp:modules.serverTimestamp()
                });
                alert('MTN Bundle Purchased! Order ID: '+orderId);
                document.getElementById('mtnModal').classList.remove('show');
            } catch(e) { console.error(e); alert('Payment successful but error logging. Ref: '+res.reference); }
        };

        await handlePayment(email, selectedMTNPrice, orderId, {
            custom_fields: [{display_name:'MTN Number', variable_name:'mtn_number', value:number}]
        }, successHandler, btn);
    };
    
    const orderBtnHandler = document.createElement('button');
    orderBtnHandler.id = 'orderBtn_handler'; orderBtnHandler.style.display = 'none';
    document.body.appendChild(orderBtnHandler);
    orderBtnHandler.onclick = async () => {
        const modules = await firebaseModulesPromise;
        if(!modules || !modules.auth.currentUser){ alert('Please Sign In first.'); return; }
        if(cart.length===0){alert('Cart empty!'); return;}
        
        let total = 0; let itemsList = '';
        cart.forEach((i, index)=>{
          const subtotal = i.price * i.qty;
          itemsList += `\n*${index + 1}.* ${i.name} (x${i.qty} @ â‚µ${i.price} = â‚µ${subtotal})`;
          total += subtotal;
        });

        let message=`Hello Luxe Store! Confirming order details.\n\n*Account:* ${modules.auth.currentUser.email}\n*--- ORDER ---*${itemsList}\n\n*TOTAL: â‚µ${total}*\n\nPlease provide delivery info.`;
        window.open(`https://wa.me/${CUSTOMER_SERVICE_NUMBER}?text=${encodeURIComponent(message)}`, '_blank');
    };
}
</script>
</body>
</html>
