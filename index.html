<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Luxe Store</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

<style>
    /* --- MODERN CSS VARIABLES --- */
    :root {
        --primary: #D4AF37; /* Elegant Gold */
        --primary-hover: #b5952f;
        --secondary: #2c3e50;
        --accent-green: #27ae60;
        --accent-red: #e74c3c;
        --accent-orange: #f39c12;
        
        --bg-body: #f9f9f9;
        --bg-card: #ffffff;
        --text-main: #333333;
        --text-light: #777777;
        --border-color: #e1e1e1;
        
        --shadow-sm: 0 2px 8px rgba(0,0,0,0.05);
        --shadow-md: 0 8px 24px rgba(0,0,0,0.08);
        --radius: 12px;
        --transition: all 0.3s ease;
    }

    /* Dark Mode Variables */
    body.dark {
        --bg-body: #121212;
        --bg-card: #1e1e1e;
        --text-main: #f1f1f1;
        --text-light: #aaaaaa;
        --border-color: #333333;
        --shadow-sm: 0 2px 8px rgba(0,0,0,0.3);
        --shadow-md: 0 8px 24px rgba(0,0,0,0.4);
    }

    /* --- RESET & TYPOGRAPHY --- */
    * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
    
    body {
        background: var(--bg-body);
        color: var(--text-main);
        font-family: 'Poppins', sans-serif;
        font-size: 14px;
        transition: var(--transition);
        line-height: 1.6;
        -webkit-font-smoothing: antialiased;
        padding-bottom: 60px; /* Space for scroll indicator */
    }

    h1, h2, h3 { font-family: 'Playfair Display', serif; color: var(--text-main); }

    /* --- HEADER --- */
    header {
        background: rgba(255, 255, 255, 0.9); /* Glass effect */
        backdrop-filter: blur(10px);
        padding: 15px 20px;
        position: sticky;
        top: 0;
        z-index: 100;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 4px 20px rgba(0,0,0,0.03);
        border-bottom: 1px solid var(--border-color);
    }

    body.dark header { background: rgba(30, 30, 30, 0.9); border-bottom: 1px solid #333; }

    .header-logo { height: 45px; width: 45px; object-fit: contain; }
    
    .header-content { flex-grow: 1; text-align: center; }
    .header-content h1 { font-size: 1.6rem; margin-bottom: 2px; letter-spacing: 0.5px; }
    
    .welcome-message { 
        font-size: 0.8rem; 
        color: var(--accent-red); 
        font-weight: 600; 
        letter-spacing: 0.5px;
        text-transform: uppercase;
        background: rgba(231, 76, 60, 0.1);
        padding: 4px 12px;
        border-radius: 20px;
        display: inline-block;
    }

    #menuBtn { 
        background: transparent; 
        border: none; 
        font-size: 24px; 
        cursor: pointer; 
        color: var(--text-main); 
        padding: 5px;
        transition: var(--transition);
    }
    #menuBtn:hover { transform: scale(1.1); color: var(--primary); }

    /* notification bell */
    .notif-wrap { position: relative; margin-right: 12px; display:flex; align-items:center; gap:8px; }
    #notifBell { background: transparent; border: none; cursor:pointer; font-size:20px; padding:8px; border-radius:8px; transition: var(--transition); }
    #notifBell:hover { background: rgba(0,0,0,0.04); color: var(--primary); }
    .notif-badge { position: absolute; top: 6px; right: 0; background: var(--accent-red); color:white; font-size:11px; padding:4px 7px; border-radius:999px; font-weight:700; display:none; min-width:20px; text-align:center; }

    /* --- PRODUCT GRID --- */
    .products {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
        gap: 25px;
        padding: 30px 20px;
        max-width: 1200px;
        margin: 0 auto;
    }

    /* --- PRODUCT CARDS --- */
    .card {
        background: var(--bg-card);
        border-radius: var(--radius);
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border-color);
        overflow: hidden;
        transition: var(--transition);
        display: flex;
        flex-direction: column;
        position: relative;
    }

    /* --- CUSTOM BUNDLE CARD UI (Requested Change) --- */
    .mtn-card {
        border: 2px solid var(--primary); /* Gold border to stand out */
        background: linear-gradient(180deg, var(--bg-card) 0%, rgba(212, 175, 55, 0.05) 100%); /* Slight gold tint */
        transform: scale(1.01); /* Slightly larger */
        box-shadow: 0 4px 20px rgba(212, 175, 55, 0.15);
    }

    .card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-md);
        border-color: var(--primary);
    }

    .card img {
        width: 100%;
        height: 220px;
        object-fit: cover;
        cursor: pointer;
        background: #f4f4f4;
        transition: transform 0.5s ease;
    }
    
    .card:hover img { transform: scale(1.03); }

    .card-body { padding: 20px; display: flex; flex-direction: column; flex-grow: 1; text-align: left; }
    
    .card-body h3 { 
        font-size: 1.1rem; 
        margin-bottom: 8px; 
        font-weight: 600;
        min-height: 40px; /* Aligns cards */
    }

    .price { font-size: 1.2rem; font-weight: 700; color: var(--primary); margin-bottom: 10px; }
    .price span { text-decoration: line-through; color: var(--text-light); font-weight: 400; font-size: 0.9rem; margin-right: 8px; }

    /* Stock Status */
    .stock-display { font-size: 0.8rem; margin-bottom: 15px; font-weight: 500; }
    .in-stock { color: var(--accent-green); background: rgba(46, 204, 113, 0.1); padding: 3px 8px; border-radius: 4px; }
    .low-stock { color: var(--accent-orange); background: rgba(243, 156, 18, 0.1); padding: 3px 8px; border-radius: 4px; }
    .out-of-stock { color: var(--accent-red); background: rgba(231, 76, 60, 0.1); padding: 3px 8px; border-radius: 4px; }

    /* Buttons */
    .buttons { display: flex; gap: 10px; margin-top: auto; }
    
    .buttons button, .pay {
        flex: 1;
        padding: 10px 15px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.9rem;
        cursor: pointer;
        transition: var(--transition);
        font-family: 'Poppins', sans-serif;
    }

    /* --- ANIMATIONS FOR GLOW --- */
    @keyframes glow-gold {
        0% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0.4); }
        70% { box-shadow: 0 0 0 10px rgba(212, 175, 55, 0); }
        100% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0); }
    }
    
    @keyframes glow-pulse {
        0% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(212, 175, 55, 0); }
        100% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0); }
    }

    @keyframes glow-soft {
        0% { box-shadow: 0 0 2px rgba(0,0,0,0.1); }
        50% { box-shadow: 0 0 8px rgba(0,0,0,0.2); }
        100% { box-shadow: 0 0 2px rgba(0,0,0,0.1); }
    }

    @keyframes bounce {
        0%, 20%, 50%, 80%, 100% {transform: translateY(0) translateX(-50%);}
        40% {transform: translateY(-10px) translateX(-50%);}
        60% {transform: translateY(-5px) translateX(-50%);}
    }

    .buy, .pay {
        background: var(--primary);
        color: white;
        /* STRONG GLOW Animation */
        animation: glow-gold 2s infinite;
    }

    .buy:hover, .pay:hover { background: var(--primary-hover); transform: translateY(-2px); }
    .buy:disabled, .pay:disabled { background: #ccc; cursor: not-allowed; box-shadow: none; transform: none; animation: none; }

    .details {
        background: transparent;
        color: var(--text-main);
        border: 1px solid var(--border-color);
        /* SOFT GLOW Animation */
        animation: glow-soft 3s infinite;
    }
    .details:hover { background: var(--bg-body); border-color: var(--text-main); }

    /* --- SCROLL INDICATOR --- */
    .scroll-indicator {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--secondary);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        z-index: 99;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        animation: bounce 2s infinite;
        opacity: 0.9;
        display: flex;
        align-items: center;
        gap: 5px;
    }
    .scroll-indicator:hover { opacity: 1; background: var(--primary); }

    /* --- INPUTS --- */
    input, select {
        width: 100%;
        padding: 12px 15px;
        margin: 8px 0 16px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        background: var(--bg-body);
        color: var(--text-main);
        font-family: 'Poppins', sans-serif;
        transition: var(--transition);
    }
    input:focus, select:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
    }

    /* --- SIDE MENU --- */
    #sideMenu {
        position: fixed;
        top: 0;
        left: 0;
        width: 280px;
        height: 100%;
        background: var(--bg-card);
        z-index: 2000;
        box-shadow: 5px 0 25px rgba(0,0,0,0.1);
        transform: translateX(-100%);
        transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        padding: 30px;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    #sideMenu.open { transform: translateX(0); }
    
    #sideMenu h3 { font-size: 1.5rem; margin-bottom: 20px; color: var(--primary); }
    
    #sideMenu button {
        padding: 14px;
        border-radius: 10px;
        border: none;
        font-weight: 500;
        cursor: pointer;
        text-align: left;
        width: 100%;
        background: var(--bg-body);
        color: var(--text-main);
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 0.95rem;
    }
    
    #sideMenu button:hover { background: var(--border-color); padding-left: 18px; }
    
    #sideMenu #cartBtn_menu, #sideMenu #orderBtn_menu { 
        background: var(--primary); 
        color: white; 
    }
    #sideMenu #cartBtn_menu:hover, #sideMenu #orderBtn_menu:hover { background: var(--primary-hover); }

    #menuOverlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.5);
        backdrop-filter: blur(3px);
        z-index: 1999;
    }

    /* --- MODALS --- */
    .modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.7);
        backdrop-filter: blur(5px);
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 20px;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    .modal.show { display: flex; opacity: 1; }
    
    .modal-box {
        background: var(--bg-card);
        color: var(--text-main);
        padding: 30px;
        border-radius: 16px;
        max-width: 500px;
        width: 100%;
        max-height: 85vh;
        overflow-y: auto;
        position: relative;
        box-shadow: 0 20px 50px rgba(0,0,0,0.2);
        animation: slideUp 0.3s ease-out;
    }
    
    @keyframes slideUp {
        from { transform: translateY(20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    .close {
        position: absolute;
        right: 20px;
        top: 20px;
        font-size: 24px;
        cursor: pointer;
        color: var(--text-light);
        transition: 0.2s;
    }
    .close:hover { color: var(--accent-red); }

    .modal-box h3 { margin-bottom: 20px; font-size: 1.5rem; border-bottom: 2px solid var(--primary); display: inline-block; padding-bottom: 5px; }

    /* Cart Items */
    .cart-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid var(--border-color);
        font-size: 0.95rem;
    }
    .cart-item button {
        background: var(--border-color);
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-left: 5px;
        cursor: pointer;
        font-weight: bold;
    }
    
    /* Notice List */
    .notice ul { list-style: none; padding: 0; }
    .notice li {
        background: rgba(212, 175, 55, 0.1);
        padding: 10px;
        margin-bottom: 8px;
        border-radius: 6px;
        border-left: 3px solid var(--primary);
        font-size: 0.9rem;
    }

    /* --- MTN Bundle Grid (MODIFIED as requested) --- */
    .mtn-bundles { 
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); 
        gap: 15px; 
        margin-top: 20px; 
    }

    .mtn-bundles button { 
        border: 2px solid var(--primary); 
        background: var(--bg-card); 
        color: var(--text-main);
        border-radius: 50px; /* Real Curvy Buttons */
        padding: 12px;
        font-weight: 700;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        box-shadow: 0 4px 6px rgba(0,0,0,0.1); /* Real button shadow */
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    .mtn-bundles button:hover {
        transform: translateY(-3px);
        box-shadow: 0 7px 14px rgba(0,0,0,0.15);
        background: rgba(212, 175, 55, 0.1);
    }

    .mtn-bundles button.selected { 
        background: var(--primary); 
        color: #fff;
        border-color: var(--primary);
        transform: scale(1.05);
        /* Glow Feature Logic */
        box-shadow: 0 0 15px var(--primary);
        animation: glow-pulse 1.5s infinite;
    }

    /* Image Viewer: improved visibility and controls */
    #imageViewerModal .modal-box { background: transparent; box-shadow: none; width: 100%; height: 100%; max-width: none; padding: 0; display:flex; align-items:center; justify-content:center; position:relative; }
    #largeProductImage { max-height: 80vh; max-width: 90%; border-radius: 8px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); display:block; margin:auto; }
    .viewer-nav { position:absolute; top:50%; transform:translateY(-50%); width:48px; height:48px; border-radius:50%; font-size:24px; display:flex; align-items:center; justify-content:center; background: rgba(0,0,0,0.6); color: white; border:none; z-index: 1100; cursor:pointer; }
    .viewer-nav:hover { background: rgba(0,0,0,0.8); transform: translateY(-50%) scale(1.04); }
    #viewerPrev { left: 20px; }
    #viewerNext { right: 20px; }

    /* viewer close - highly visible */
    #viewerClose { position:absolute; top:16px; right:16px; width:44px; height:44px; border-radius:50%; background: rgba(0,0,0,0.7); color: white; display:flex; align-items:center; justify-content:center; font-size:20px; z-index:1200; cursor:pointer; }
    #viewerClose:hover { background: rgba(0,0,0,0.9); transform: scale(1.04); }

    /* notification modal content */
    #userNotifModal .modal-box { max-width: 520px; }
    .notif-list { max-height: 50vh; overflow:auto; padding: 8px; }
    .notif-item { padding: 10px; border-bottom:1px solid #eee; font-size:0.95rem; }
    .notif-item.unread { background: rgba(212,175,55,0.05); }

    /* toast */
    .toast { position: fixed; right: 18px; bottom: 18px; background: #111; color:#fff; padding: 12px 16px; border-radius: 10px; box-shadow: 0 6px 20px rgba(0,0,0,0.3); z-index: 4000; opacity:0; transform: translateY(10px); transition: all 0.25s ease; max-width:320px; }
    .toast.show { opacity:1; transform: translateY(0); }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: var(--bg-body); }
    ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

    /* Responsive */
    @media (max-width: 600px) {
        .products { grid-template-columns: 1fr; padding: 15px; }
        .card img { height: 200px; }
        .header-logo { height: 35px; width: 35px; }
        .header-content h1 { font-size: 1.3rem; }
        .viewer-nav { width:40px; height:40px; font-size:20px; }
        #viewerClose { width:40px; height:40px; font-size:18px; }
    }
</style>
</head>
<body>

<div class="modal show" id="authModal">
  <div class="modal-box" style="text-align: center; max-width: 400px;">
    <h2>Welcome to Luxe Store</h2>
    <p>Please Sign In or Sign Up to access the store.
    (MUST READ INSTRUCTIONS FROM NOTICE!!)</p>
    <input id="authEmail" type="email" placeholder="Email">
    <input id="authPassword" type="password" placeholder="Password">
    <button class="pay" id="signInBtn" style="margin-top: 15px;">Sign In</button>
    <button class="pay" id="signUpBtn" style="margin-top: 8px;">Sign Up</button>
    <p id="authError" style="color: red; margin-top: 10px;"></p>
  </div>
</div>

<div id="sideMenu">
    <h3>Menu</h3>
    <button id="cartBtn_menu">üõí Cart</button>
    <button id="orderBtn_menu">üí¨ Confirm Order</button>
    <button id="themeBtn_menu">Light / Dark</button>
    <button id="notifyBtn_menu">üîî Notice</button>
    <button id="supportBtn_menu">üìû Customer Service</button> 
    <button id="whatsappGroupBtn_menu" style="background: #25d366; color: white;">üë• WhatsApp Group</button>
    <button id="adminBtn_menu" style="display: none; background: var(--primary); color: white;">üõ†Ô∏è Admin Dashboard</button>
    <button id="logoutBtn_menu" style="display: none;">Log Out</button>
</div>
<div id="menuOverlay"></div>

<header>
    <button id="menuBtn">‚ò∞</button> 
    <div class="header-content">
        <div style="display:flex; align-items:center; justify-content:center; gap:12px;">
            <img src="images/luxe_logo.png" alt="Luxe Store Logo" class="header-logo">
            <div>
                <h1>Luxe Store</h1>
                <p class="welcome-message" style="color: red; font-weight: bold;">
                    FLASH SALES!!!!(MUST READ INSTRUCTIONS FROM NOTICE "IN THE MENU!!")
                </p>
            </div>
        </div>
    </div>

    <!-- notif bell + spacer -->
    <div style="display:flex; align-items:center;">
      <div class="notif-wrap">
        <button id="notifBell" title="Notifications">üîîMSG</button>
        <div class="notif-badge" id="notifBadge">0</div>
      </div>
      <div style="width: 12px;"></div>
    </div>
</header>

<div class="scroll-indicator" id="scrollDownBtn">
    Scroll Down <span>‚Üì</span>
</div>

<div class="products">
    <div class="card" id="card_blender" data-id="blender" data-name="Silver Crest Blender 2in1 2.0L" data-price="285" data-images="images/blender.jpg,images/blenders.jpg,images/blender2.jpg" data-description="Powerful 2.0L blender with stainless steel blades.">
        <img src="images/blender.jpg" data-product-index="0">
        <div class="card-body">
            <h3>Silver Crest Blender 2-in1- 2.0L</h3>
            <p class="price"><span style="text-decoration: line-through; color: #888; font-size: 0.9em; margin-right: 5px;">‚Çµ300</span> ‚Çµ285</p>
            <p class="stock-display" id="stock_blender">Checking stock...</p>
            <div class="buttons"><button class="buy" id="btn_blender">Add to Cart</button><button class="details">More Details</button></div>
        </div>
    </div>
    
    <div class="card" id="card_earphones" data-id="earphones" data-name="Superbass 2-in-1 Earphones" data-price="61.75" data-images="images/headphones.jpg,images/headphones1.jpg" data-description="High-fidelity audio with deep bass.">
        <img src="images/headphones.jpg" data-product-index="1">
        <div class="card-body">
            <h3>Superbass 2-in-1 Earphones</h3>
            <p class="price"><span style="text-decoration: line-through; color: #888; font-size: 0.9em; margin-right: 5px;">‚Çµ65</span> ‚Çµ61.75</p>
            <p class="stock-display" id="stock_earphones">Checking stock...</p>
            <div class="buttons"><button class="buy" id="btn_earphones">Add to Cart</button><button class="details">More Details</button></div>
        </div>
    </div>
    
    <div class="card" id="card_watch" data-id="watch" data-name="Rich Ripple Smart Watch" data-price="190" data-images="images/smartwatch.jpg,images/smartwatch1.jpg" data-description="Sleek smart watch with a vibrant display.">
        <img src="images/smartwatch.jpg" data-product-index="2">
        <div class="card-body">
            <h3>Rich Ripple Smart Watch</h3>
            <p class="price"><span style="text-decoration: line-through; color: #888; font-size: 0.9em; margin-right: 5px;">‚Çµ200</span> ‚Çµ190</p>
            <p class="stock-display" id="stock_watch">Checking stock...</p>
            <div class="buttons"><button class="buy" id="btn_watch">Add to Cart</button><button class="details">More Details</button></div>
        </div>
    </div>
    
    <div class="card" id="card_cable" data-id="cable" data-name="3-in-1 60W USB Cable" data-price="47.5" data-images="images/accessories.jpg,images/accessories1.jpg" data-description="Durable, braided cable with 60W fast charging.">
        <img src="images/accessories.jpg" data-product-index="3">
        <div class="card-body">
            <h3>3-in-1 60W USB Cable</h3>
            <p class="price"><span style="text-decoration: line-through; color: #888; font-size: 0.9em; margin-right: 5px;">‚Çµ50</span> ‚Çµ47.50</p>
            <p class="stock-display" id="stock_cable">Checking stock...</p>
            <div class="buttons"><button class="buy" id="btn_cable">Add to Cart</button><button class="details">More Details</button></div>
        </div>
    </div>
    
    <div class="card" id="card_powerbank" data-id="powerbank" data-name="Oraimo Traveler Powerbank 10000mAh" data-price="190" data-images="images/powerbank.jpg,images/powerbank1.jpg" data-description="Compact 10,000mAh powerbank.">
        <img src="images/powerbank.jpg" data-product-index="4">
        <div class="card-body">
            <h3>Oraimo Traveler Powerbank</h3>
            <p class="price"><span style="text-decoration: line-through; color: #888; font-size: 0.9em; margin-right: 5px;">‚Çµ200</span> ‚Çµ190</p>
            <p class="stock-display" id="stock_powerbank">Checking stock...</p>
            <div class="buttons"><button class="buy" id="btn_powerbank">Add to Cart</button><button class="details">More Details</button></div>
        </div>
    </div>

    <div class="card mtn-card" data-name="MTN Data Bundles" data-price="0" data-images="images/databundles.jpg" data-description=" Delivery is not instant bare in mind!.">
        <img src="images/databundles.jpg" data-product-index="5">
        <div class="card-body">
            <h3>MTN Data Bundles</h3>
            <p class="price">‚Çµ6.00 ‚Äì ‚Çµ60.00</p>
            <div class="buttons"><button class="buy" id="mtnOpenBtn">Buy Bundle</button><button class="details" id="mtnDetailsBtn">More Details</button></div>
        </div>
    </div>
</div>

<div class="modal" id="cartModal">
<div class="modal-box">
<span class="close">√ó</span>
<h3>Your Cart</h3>
<div id="cartItems"></div>
<p style="font-size: 1.2rem; font-weight: bold; margin: 15px 0;"><strong>Total:</strong> ‚Çµ<span id="cartTotal">0</span></p>
<input id="custName" placeholder="Your name">
<input id="custPhone" placeholder="Phone number">
<input id="custEmail" placeholder="Email">
<button class="pay" id="checkoutBtn">Checkout & Pay</button>
<!-- NEW: Place order WITHOUT payment (for admin to process manually) -->
<!-- CHANGE: made this 'pay' class to appear lively like checkout -->
<button class="pay" id="placeOrderBtn" style="margin-top:10px;">Place Order (No Payment)</button>
</div>
</div>

<div class="modal" id="detailsModal">
    <div class="modal-box">
        <span class="close">√ó</span>
        <h3 id="detailsTitle"></h3>
        <p id="detailsDescription" style="margin-bottom: 20px; line-height: 1.6;"></p>
        <p style="background: rgba(0,0,0,0.05); padding: 10px; border-radius: 8px; font-size: 0.9rem;"><strong>Delivery:</strong> Takes 14-21 business days of delivery time for all products except for DATABUNDLES take note!!</p>
    </div>
</div>

<div class="modal" id="imageViewerModal">
    <div class="modal-box">
        <span id="viewerClose">√ó</span>
        <button id="viewerPrev" class="viewer-nav">&#10094;</button>
        <img id="largeProductImage" src="">
        <button id="viewerNext" class="viewer-nav">&#10095;</button>
        <div style="color: white; margin-top: 10px; position:absolute; bottom:12px; left:50%; transform:translateX(-50%);">Tap or click image to zoom/unzoom.</div>
    </div>
</div>

<div class="modal" id="mtnModal">
<div class="modal-box">
<span class="close">√ó</span>
<h3>MTN Data Bundles</h3>
<p>Select a bundle and enter your MTN number:</p>
<div class="mtn-bundles">
<button data-price="6">1GB ‚Äì ‚Çµ6</button>
<button data-price="12">2GB ‚Äì ‚Çµ12</button>
<button data-price="18">3GB ‚Äì ‚Çµ18</button>
<button data-price="24">4GB ‚Äì ‚Çµ24</button>
<button data-price="30">5GB ‚Äì ‚Çµ30</button>
<button data-price="36">6GB ‚Äì ‚Çµ36</button>
<button data-price="42">7GB ‚Äì ‚Çµ42</button>
<button data-price="48">8GB ‚Äì ‚Çµ48</button>
<button data-price="54">9GB ‚Äì ‚Çµ54</button>
<button data-price="60">10GB ‚Äì ‚Çµ60</button> </div>
<input id="mtnNumber" placeholder="MTN Number (e.g. 054xxxxxxx)">
<input id="mtnName" placeholder="Your name">
<input id="mtnEmail" placeholder="Email">
<button class="pay" id="mtnPay">Pay for Bundle</button>
</div>
</div>

<div class="modal" id="noticeModal">
<div class="modal-box">
<span class="close">√ó</span>
<h3>Must Read Before Purchase</h3>
<div class="notice">
<ul>
<li>USER MUST CONFIRM ORDER BEFORE PAYMENT ON THE SITE TO ENSURE SMOOTH DELIVERY!!</li>
<li>All products are ready for delivery.</li>
<li>Users must provide correct info before and after payment.</li>
<li>TURBONET / BROADBAND SIMs do not work for this type of data bundles.</li>
<li>Purchase for wrong numbers are non-refundable.</li>
<li>Data bundle delivery: 30 mins ‚Äì 1 hr(2hrs max) for only DATABUNDLES.</li>
</ul>
</div>
</div>
</div>

<!-- Admin Modal -->
<div class="modal" id="adminModal">
  <div class="modal-box" style="max-width: 900px;">
    <span class="close">√ó</span>
    <h3>Admin Dashboard ‚Äî Orders</h3>
    <div id="adminSearchContainer" style="margin-bottom:12px; display:flex; gap:8px; align-items:center;">
  <input id="adminSearchInput" type="text" placeholder="Enter Order ID" style="flex:1; padding:6px; border-radius:6px; border:1px solid #ccc;">
  <button id="adminSearchBtn" style="padding:6px 10px; border-radius:6px; border:none; background:#007bff; color:white; cursor:pointer;">Search</button>
  <button id="adminResetBtn" style="padding:6px 10px; border-radius:6px; border:none; background:#6c757d; color:white; cursor:pointer;">Reset</button>
</div>
    <div id="adminOrdersContainer" style="font-size: 0.95rem;">
      <p>Loading orders...</p>
    </div>
  </div>
</div>

<!-- User Notifications Modal -->
<div class="modal" id="userNotifModal">
  <div class="modal-box">
    <span class="close">√ó</span>
    <h3>Your Notifications</h3>
    <div class="notif-list" id="notifList">
      <p>No notifications yet.</p>
    </div>
    <div style="margin-top:12px; display:flex; gap:8px;">
      <button id="markAllReadBtn" style="padding:10px; border-radius:8px; border:none; background:var(--primary); color:white;">Mark all read</button>
      <button id="clearNotifBtn" style="padding:10px; border-radius:8px; border:1px solid var(--border-color);">Clear</button>
    </div>
  </div>
</div>

<!-- toast container will be created dynamically -->

<script type="module">
// --- GLOBAL CONFIGURATION ---
const PAYSTACK_PUBLIC_KEY = 'pk_live_98575428080557d261e91cb92fe745f878fc4278';
const CUSTOMER_SERVICE_NUMBER = '233548164533'; 
const DEFAULT_USER_EMAIL = 'jbellingham771@gmail.com'; 
const WHATSAPP_GROUP_LINK = 'https://chat.whatsapp.com/GxS4tPlo8sqH8xkbARNvPc';

// ---- IMPORTANT: set your admin uid here (replace with real uid) ----
const ADMIN_UID = 'xDct2LPsWwfcjkRl9TwhU0CCwho1'; // <<--- change this to your firebase auth UID

// --- INVENTORY MANAGEMENT (CHANGE NUMBERS HERE TO UPDATE STOCK) ---
const STORE_INVENTORY = {
    'blender': 20,
    'earphones': 50,
    'watch': 15,
    'cable': 100,
    'powerbank': 12
};

let cart = [];
let allProductsData = []; 
let currentStockState = {}; // Keeps track of live stock
let PaystackPop; 

// -------------------- Notification helpers --------------------
let userNotifications = []; // in-memory list for UI
let unreadCount = 0;

function updateNotifBadge() {
  const badge = document.getElementById('notifBadge');
  if(!badge) return;
  if(unreadCount > 0) {
    badge.style.display = 'block';
    badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
  } else {
    badge.style.display = 'none';
  }
}

function addUserNotification(n) {
  // n = { id, text, time (Date or string), read: bool }
  userNotifications.unshift(n);
  if(!n.read) unreadCount++;
  updateNotifBadge();
  renderNotifList();
  showToast(n.text);
}

function renderNotifList() {
  const list = document.getElementById('notifList');
  if(!list) return;
  if(userNotifications.length === 0) {
    list.innerHTML = '<p>No notifications yet.</p>'; return;
  }
  list.innerHTML = userNotifications.map(n => {
    const t = (n.time && n.time.toLocaleString) ? n.time.toLocaleString() : (n.time || '');
    return `<div class="notif-item ${n.read ? '' : 'unread'}" data-id="${n.id}">
      <div style="font-weight:600;">${n.text}</div>
      <div style="font-size:0.85rem;color:#666;margin-top:6px">${t}</div>
    </div>`;
  }).join('');
}

function markAllNotificationsRead() {
  userNotifications = userNotifications.map(n => ({...n, read:true}));
  unreadCount = 0;
  updateNotifBadge();
  renderNotifList();
}

function clearNotifications() {
  userNotifications = [];
  unreadCount = 0;
  updateNotifBadge();
  renderNotifList();
}

function showToast(msg) {
  const t = document.createElement('div');
  t.className = 'toast';
  t.textContent = msg;
  document.body.appendChild(t);
  // trigger show
  setTimeout(()=> t.classList.add('show'), 10);
  // remove after 5s
  setTimeout(()=> {
    t.classList.remove('show');
    setTimeout(()=> t.remove(), 350);
  }, 5000);
}

// -------------------- End notification helpers --------------------

function loadPaystackScript() {
    return new Promise((resolve, reject) => {
        if (window.PaystackPop) { PaystackPop = window.PaystackPop; resolve(PaystackPop); return; }
        const script = document.createElement('script');
        script.src = 'https://js.paystack.co/v1/inline.js';
        script.onload = () => { if (window.PaystackPop) { PaystackPop = window.PaystackPop; resolve(PaystackPop); } else { reject(new Error('Paystack Error')); } };
        script.onerror = () => reject(new Error('Network Error'));
        document.head.appendChild(script);
    });
}

// ---------------- firebase initialization ----------------
let app, db, auth;
let firebaseInitialized = false;

async function initializeFirebase() {
    try {
        const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js");
        const { getFirestore, collection, addDoc, doc, setDoc, getDoc, updateDoc, increment, onSnapshot, serverTimestamp, query, orderBy, getDocs, where } = await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js");
        const { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } = await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js"); 

       const firebaseConfig = {
          apiKey: "AIzaSyA6WtaQD8tqriy9_WIBV3DxV9vcKzvNSdI",
          authDomain: "luxe-datastore.firebaseapp.com",
          databaseURL: "https://luxe-datastore-default-rtdb.firebaseio.com",
          projectId: "luxe-datastore",
          storageBucket: "luxe-datastore.firebasestorage.app",
          messagingSenderId: "337992102686",
          appId: "1:337992102686:web:91b6d6802686bf688b4f0f"
        }; 

        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app); 
        firebaseInitialized = true;

        // create a modules object to pass around
        const modules = { collection, addDoc, doc, setDoc, getDoc, updateDoc, increment, onSnapshot, serverTimestamp, auth, db, getDocs, query, orderBy, where };

        // Auth Listeners
        const authModal = document.getElementById('authModal');
        const logoutBtnMenu = document.getElementById('logoutBtn_menu'); 
        const adminBtnMenu = document.getElementById('adminBtn_menu');

        onAuthStateChanged(auth, (user) => {
            if (user) {
                authModal.classList.remove('show');
                logoutBtnMenu.style.display = 'block'; 
                if(document.getElementById('custEmail')) document.getElementById('custEmail').value = user.email;
                if(document.getElementById('mtnEmail')) document.getElementById('mtnEmail').value = user.email;

                // Show admin button if this user is admin
                if(user.uid === ADMIN_UID) {
                    adminBtnMenu.style.display = 'block';
                } else {
                    adminBtnMenu.style.display = 'none';
                }

                // setup per-user listeners for notifications
                try { setupUserNotifications(modules, user.uid); } catch(e) { console.error('setupUserNotifications failed', e); }

            } else {
                authModal.classList.add('show');
                logoutBtnMenu.style.display = 'none'; 
                adminBtnMenu.style.display = 'none';
                if(document.getElementById('custEmail')) document.getElementById('custEmail').value = DEFAULT_USER_EMAIL;
                if(document.getElementById('mtnEmail')) document.getElementById('mtnEmail').value = DEFAULT_USER_EMAIL;
                // clear client-side notification state when logged out
                clearNotifications();
              }
        });

        document.getElementById('signUpBtn').onclick = async () => {
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            const err = document.getElementById('authError'); err.textContent = '';
            if (!email || password.length < 6) { err.textContent = 'Email and a password of at least 6 characters are required.'; return; }
            try { await createUserWithEmailAndPassword(auth, email, password); } catch (e) { err.textContent = e.message.replace('Firebase: Error ', ''); }
        };

        document.getElementById('signInBtn').onclick = async () => {
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            const err = document.getElementById('authError'); err.textContent = '';
            try { await signInWithEmailAndPassword(auth, email, password); } catch (e) { err.textContent = 'Sign-in failed. Check email or password.'; }
        };

        document.getElementById('logoutBtn_menu').onclick = async () => {
            try { await signOut(auth); document.getElementById('sideMenu').classList.remove('open'); document.getElementById('menuOverlay').style.display = 'none'; } catch (e) { console.error(e); }
        };
        
        // --- REAL TIME STOCK LOGIC ---
        // 1. Initialize Stock if needed
        for (const [key, qty] of Object.entries(STORE_INVENTORY)) {
            const docRef = doc(db, 'inventory', key);
            getDoc(docRef).then((snap) => {
                if (!snap.exists()) {
                    setDoc(docRef, { qty: qty }).catch(err => console.error('Failed to set initial stock for', key, err)); // Create initial stock
                }
            }).catch(err => console.error('getDoc inventory error', err));
        }

        // 2. Listen for changes and update UI
        onSnapshot(collection(db, 'inventory'), (snapshot) => {
            snapshot.forEach((d) => {
                const data = d.data();
                const productId = d.id;
                const qty = data.qty;
                currentStockState[productId] = qty; // Save for logic

                // Update UI Text
                const displayEl = document.getElementById(`stock_${productId}`);
                const btnEl = document.getElementById(`btn_${productId}`);
                
                if (displayEl) {
                    if (qty > 10) {
                        displayEl.innerHTML = `<span class="in-stock">In Stock: ${qty} items left</span>`;
                        displayEl.className = 'stock-display';
                    } else if (qty > 0) {
                        displayEl.innerHTML = `<span class="low-stock">Hurry! Only ${qty} left!</span>`;
                        displayEl.className = 'stock-display';
                    } else {
                        displayEl.innerHTML = `<span class="out-of-stock">Sold Out</span>`;
                    }
                }

                // Disable button if sold out
                if (btnEl) {
                    if (qty <= 0) {
                        btnEl.disabled = true;
                        btnEl.textContent = "Sold Out";
                        btnEl.style.backgroundColor = "#ccc";
                    } else {
                        btnEl.disabled = false;
                        btnEl.textContent = "Add to Cart";
                        btnEl.style.backgroundColor = ""; // Reset to CSS default
                    }
                }
            });
        }, (err) => console.error('inventory onSnapshot error', err));

        // Return the modules for external use
        return modules;

    } catch (error) {
        console.error("Firebase Error:", error);
        return false; 
    }
}

const firebaseModulesPromise = initializeFirebase();

// ---------------- set up user notification listeners ----------------
/*
  - modules: returned firestore utilities
  - uid: authenticated user's uid
*/
function setupUserNotifications(modules, uid) {
  if(!modules || !modules.onSnapshot || !modules.query || !modules.where) return;
  // keep track of previous statuses so we only notify on change
  const orderStatusMap = {};

  // helper to push notification
  function notifyForOrder(docData, docId, colName, changeType) {
    const orderLabel = docData.orderId || docId || 'Order';
    const status = docData.status || (docData.paid ? 'Paid' : 'pending');
    let text = '';

    if(changeType === 'added') {
      text = `${orderLabel} received ‚Äî status: ${status}`;
    } else if(changeType === 'modified') {
      text = `${orderLabel} status updated: ${status}`;
    } else {
      text = `${orderLabel}: ${status}`;
    }

    addUserNotification({
      id: `${colName}_${docId}_${Date.now()}`,
      text,
      time: new Date(),
      read: false
    });
  }

  // listen for product orders for this user
  try {
    const qOrders = modules.query(modules.collection(modules.db, 'orders'), modules.where('userId', '==', uid));
    modules.onSnapshot(qOrders, (snapshot) => {
      snapshot.docChanges().forEach(change => {
        const d = change.doc.data();
        const id = change.doc.id;
        if(change.type === 'added') {
          orderStatusMap[id] = d.status || '';
          // notify user that order is placed (pending/paid)
          notifyForOrder(d, id, 'orders', 'added');
        } else if(change.type === 'modified') {
          const prev = orderStatusMap[id] || '';
          const now = d.status || '';
          if(prev !== now) {
            orderStatusMap[id] = now;
            notifyForOrder(d, id, 'orders', 'modified');
          } else {
            // also check paid flag change
            if((d.paid === true) && prev !== 'paid') {
              orderStatusMap[id] = 'paid';
              notifyForOrder(d, id, 'orders', 'modified');
            }
          }
        }
      });
    }, (err) => { console.error('user orders notif listener error', err); });
  } catch(e) { console.error('setup orders notif failed', e); }

  // listen for mtn orders for this user
  try {
    const qMtn = modules.query(modules.collection(modules.db, 'mtn_orders'), modules.where('userId', '==', uid));
    modules.onSnapshot(qMtn, (snapshot) => {
      snapshot.docChanges().forEach(change => {
        const d = change.doc.data();
        const id = change.doc.id;
        if(change.type === 'added') {
          orderStatusMap['mtn_'+id] = d.status || '';
          notifyForOrder(d, id, 'mtn_orders', 'added');
        } else if(change.type === 'modified') {
          const prev = orderStatusMap['mtn_'+id] || '';
          const now = d.status || '';
          if(prev !== now) {
            orderStatusMap['mtn_'+id] = now;
            notifyForOrder(d, id, 'mtn_orders', 'modified');
          } else {
            if((d.paid === true) && prev !== 'paid') {
              orderStatusMap['mtn_'+id] = 'paid';
              notifyForOrder(d, id, 'mtn_orders', 'modified');
            }
          }
        }
      });
    }, (err) => { console.error('user mtn_orders notif listener error', err); });
  } catch(e) { console.error('setup mtn notif failed', e); }
}

// -------------------- DOM handlers --------------------
document.addEventListener('DOMContentLoaded', () => {
    initializeDOMHandlers(firebaseModulesPromise);
});

function initializeDOMHandlers(firebaseModulesPromise) {
    
    document.querySelectorAll('.card').forEach((card, index) => {
        allProductsData.push({
            index: index,
            id: card.dataset.id || null, // Capture the ID (may be null for mtn-card)
            name: card.dataset.name,
            images: (card.dataset.images || '').split(',').filter(s => s.trim() !== ''),
            description: card.dataset.description || ''
        });
    });

    // Scroll Down Feature Logic
    const scrollDownBtn = document.getElementById('scrollDownBtn');
    if(scrollDownBtn) {
        scrollDownBtn.onclick = () => {
            window.scrollBy({ top: 300, behavior: 'smooth' });
        };
        // Auto-hide when scrolled to bottom
        window.onscroll = () => {
            if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 50) {
                scrollDownBtn.style.display = 'none';
            } else {
                scrollDownBtn.style.display = 'flex';
            }
        };
    }

    const sideMenu = document.getElementById('sideMenu');
    const menuOverlay = document.getElementById('menuOverlay');
    const toggleMenu = () => { sideMenu.classList.toggle('open'); menuOverlay.style.display = sideMenu.classList.contains('open') ? 'block' : 'none'; };
    document.getElementById('menuBtn').onclick = toggleMenu;
    menuOverlay.onclick = toggleMenu; 
    document.getElementById('cartBtn_menu').onclick = () => { document.getElementById('cartModal').classList.add('show'); toggleMenu(); };
    document.getElementById('orderBtn_menu').onclick = () => { document.getElementById('orderBtn_handler').click(); toggleMenu(); };
    document.getElementById('themeBtn_menu').onclick = () => { document.body.classList.toggle('dark'); };
    document.getElementById('notifyBtn_menu').onclick = () => { document.getElementById('noticeModal').classList.add('show'); toggleMenu(); };
    document.getElementById('supportBtn_menu').onclick = () => { window.open(`https://wa.me/${CUSTOMER_SERVICE_NUMBER}?text=Hello Luxe Store Customer Service`, '_blank'); toggleMenu(); };
    document.getElementById('whatsappGroupBtn_menu').onclick = () => { window.open(WHATSAPP_GROUP_LINK, '_blank'); toggleMenu(); };

    // Admin dashboard opener
document.getElementById('adminBtn_menu').onclick = () => {
  document.getElementById('adminModal').classList.add('show');
  toggleMenu();
  loadAdminOrders(); // populate admin data
};

(function setupAdminSearch() {
  const searchInput = document.getElementById('adminSearchInput');
  const searchBtn = document.getElementById('adminSearchBtn');
  const resetBtn = document.getElementById('adminResetBtn');
  const ordersContainer = document.getElementById('adminOrdersContainer');

  async function searchOrderByID() {
    const orderID = searchInput.value.trim();
    if (!orderID) {
      alert('Enter an Order ID to search.');
      return;
    }

    try {
      const modules = await firebaseModulesPromise;
      const { db, collection, query, where, getDocs } = modules;

      // Clear current display
      ordersContainer.innerHTML = '';

      // Search 'orders' collection
      const ordersQuery = query(collection(db, 'orders'), where('orderId', '==', orderID));
      const ordersSnap = await getDocs(ordersQuery);

      if (!ordersSnap.empty) {
        ordersSnap.forEach(docSnap => displayOrder(docSnap, 'orders'));
        return;
      }

      // Search 'mtn_orders' collection
      const mtnQuery = query(collection(db, 'mtn_orders'), where('orderId', '==', orderID));
      const mtnSnap = await getDocs(mtnQuery);

      if (!mtnSnap.empty) {
        mtnSnap.forEach(docSnap => displayOrder(docSnap, 'mtn_orders'));
        return;
      }

      alert('Order ID not found.');
    } catch (err) {
      console.error(err);
      alert('Error fetching order.');
    }
  }

  function displayOrder(snap, collectionName) {
    const data = snap.data();
    const div = document.createElement('div');
    div.style = "border:1px solid #ddd; padding:10px; margin-bottom:6px; border-radius:6px; background:#f9f9f9;";
    div.innerHTML = `
      <strong>Order ID:</strong> ${data.orderId || snap.id} <br>
      <strong>Collection:</strong> ${collectionName} <br>
      <strong>User:</strong> ${data.userName || 'N/A'} <br>
      <strong>Status:</strong> ${data.status || 'N/A'} <br>
      <strong>Timestamp:</strong> ${data.timestamp?.toDate ? data.timestamp.toDate() : data.timestamp || 'N/A'} <br>
      <strong>Details:</strong> ${JSON.stringify(data.items || data.bundle || data.products || {})}
    `;
    ordersContainer.appendChild(div);
  }

  searchBtn.onclick = searchOrderByID;
  searchInput.addEventListener('keypress', e => { if(e.key === 'Enter') searchOrderByID(); });
  resetBtn.onclick = () => {
    searchInput.value = '';
    if (typeof loadAdminOrders === 'function') loadAdminOrders();
  };
})();

// User notification modal opener
document.getElementById('notifBell').onclick = () => {
  document.getElementById('userNotifModal').classList.add('show');
  // mark read on open (optional)
  // markAllNotificationsRead();
};

    document.getElementById('markAllReadBtn').onclick = () => { markAllNotificationsRead(); };
    document.getElementById('clearNotifBtn').onclick = () => { clearNotifications(); };

    // close handlers (includes viewerClose)
    document.querySelectorAll('.close, #viewerClose').forEach(c => c.onclick = () => document.querySelectorAll('.modal').forEach(m => m.classList.remove('show')));

    const cartItems=document.getElementById('cartItems');
    const cartTotal=document.getElementById('cartTotal');
    function renderCart(){
      cartItems.innerHTML=''; let total=0;
      cart.forEach((i,idx)=>{
        total+=i.price*i.qty;
        const div=document.createElement('div');
        div.className='cart-item';
        div.innerHTML=`${i.name} x${i.qty} `;
        const plus=document.createElement('button'); plus.textContent='+'; 
        plus.onclick=()=>{
            // Check stock before adding more
            if(i.id && currentStockState[i.id] && i.qty >= currentStockState[i.id]) {
                alert(`Sorry, only ${currentStockState[i.id]} left in stock!`);
                return;
            }
            i.qty++; renderCart();
        };
        const minus=document.createElement('button'); minus.textContent='-'; minus.onclick=()=>{i.qty>1?i.qty--:cart.splice(idx,1); renderCart();};
        div.appendChild(plus); div.appendChild(minus);
        cartItems.appendChild(div);
      });
      cartTotal.textContent=total;
    }

    const imageViewerModal = document.getElementById('imageViewerModal');
    const largeProductImage = document.getElementById('largeProductImage');
    const viewerPrev = document.getElementById('viewerPrev');
    const viewerNext = document.getElementById('viewerNext');
    let currentViewerImages = [], currentViewerIndex = 0;

    function updateImageViewer() {
        largeProductImage.src = currentViewerImages[currentViewerIndex] || '';
        largeProductImage.classList.remove('zoomed'); 
        viewerPrev.style.display = currentViewerImages.length > 1 ? 'flex' : 'none';
        viewerNext.style.display = currentViewerImages.length > 1 ? 'flex' : 'none';
    }
    viewerPrev.onclick = () => { if(currentViewerIndex > 0) currentViewerIndex--; updateImageViewer(); };
    viewerNext.onclick = () => { if(currentViewerIndex < currentViewerImages.length - 1) currentViewerIndex++; updateImageViewer(); };
    largeProductImage.onclick = () => { largeProductImage.classList.toggle('zoomed'); };

    // allow keyboard navigation inside viewer for convenience
    document.addEventListener('keydown', (e) => {
      if(document.getElementById('imageViewerModal').classList.contains('show')) {
        if(e.key === 'ArrowLeft') viewerPrev.click();
        if(e.key === 'ArrowRight') viewerNext.click();
        if(e.key === 'Escape') document.querySelectorAll('.modal').forEach(m => m.classList.remove('show'));
      }
    });

    document.querySelectorAll('.card').forEach(card=>{
      const name=card.dataset.name;
      const prodId=card.dataset.id; // Get ID
      const description = card.dataset.description;
      const productIndex = Number(card.querySelector('img').dataset.productIndex || 0); 
      
      const imgEl = card.querySelector('img');
      if(imgEl) {
        imgEl.onclick = () => {
            if(allProductsData[productIndex]) {
               currentViewerImages = allProductsData[productIndex].images;
               currentViewerIndex = 0;
               updateImageViewer();
               imageViewerModal.classList.add('show');
            }
        };
      }
      
      if(card.querySelector('.buy') && !card.classList.contains('mtn-card')){
        card.querySelector('.buy').onclick=()=>{
          // Initial Stock Check
          if(prodId && currentStockState[prodId] <= 0) {
              alert("Sorry, this item is sold out.");
              return;
          }

          let item = cart.find(i => i.name === name);
          if (item) {
              if(prodId && currentStockState[prodId] && item.qty >= currentStockState[prodId]) {
                  alert(`Sorry, only ${currentStockState[prodId]} left!`);
                  return;
              }
              item.qty++; 
          } else {
              cart.push({name, id: prodId, price:Number(card.dataset.price||0),qty:1});
          }
          renderCart();
          document.getElementById('cartModal').classList.add('show');
        };
      }
      if(card.querySelector('.details')){
        card.querySelector('.details').onclick=()=>{
          document.getElementById('detailsTitle').textContent=name;
          document.getElementById('detailsDescription').textContent=description; 
          document.getElementById('detailsModal').classList.add('show');
        };
      }
    });

    function generateOrderId(type="ORD"){
      const d=new Date();
      return `${type}-${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}-${Math.floor(Math.random()*900+100)}`;
    }

    async function handlePayment(email, amount, orderId, metadata, onSuccessCallback, btn) {
        const originalText = btn.textContent;
        btn.textContent = "Processing...";
        btn.disabled = true;

        if (typeof onSuccessCallback !== 'function') {
            alert("System Error. Reload page."); btn.textContent = originalText; btn.disabled = false; return;
        }

        try {
            const paystackPop = await loadPaystackScript();
            const handler = paystackPop.setup({
                key: PAYSTACK_PUBLIC_KEY, email: email, amount: amount * 100, currency: 'GHS', ref: orderId, metadata: metadata,
                callback: (response) => { onSuccessCallback(response); },
                onClose: () => { btn.textContent = originalText; btn.disabled = false; },
                onError: (err) => { alert('Payment Initialization Failed.'); btn.textContent = originalText; btn.disabled = false; }
            });
            handler.openIframe(); 
        } catch (error) {
            alert(`Payment setup failed: ${error.message}`); btn.textContent = originalText; btn.disabled = false;
        }
    }

    document.getElementById('checkoutBtn').onclick = async function() {
        const btn = this;
        const modules = await firebaseModulesPromise;

        if(!modules || !modules.auth || !modules.auth.currentUser){ alert('Please Sign In first.'); return; } 
        if(cart.length===0){alert('Cart empty!'); return;}
        
        // FINAL STOCK CHECK BEFORE PAYMENT
        let stockIssue = false;
        cart.forEach(item => {
            if (item.id && currentStockState[item.id] < item.qty) {
                alert(`Stock changed! We only have ${currentStockState[item.id]} of ${item.name} left.`);
                stockIssue = true;
            }
        });
        if(stockIssue) return;

        const name=document.getElementById('custName').value.trim();
        const phone=document.getElementById('custPhone').value.trim();
        const email=document.getElementById('custEmail').value.trim();
        const total=Number(cartTotal.textContent);
        
        if(!name||!phone||!email){alert('Please fill all details.'); return;}

        const orderId = generateOrderId("ORD");
        const userId = modules.auth.currentUser.uid;

        const successHandler = async (res) => {
            try {
                // 1. Record Order into 'orders' collection (separate from mtn orders)
                const orderObject = {
                    orderId,
                    userId,
                    customerName: name,
                    customerPhone: phone,
                    customerEmail: email,
                    items: cart.map(i => ({ id: i.id || null, name: i.name, price: i.price, qty: i.qty })),
                    totalAmount: total,
                    status: 'Paid',
                    paid: true,
                    transactionId: res.reference || null,
                    reference: res.reference,
                    timestamp: modules.serverTimestamp()
                };

                // ensure modules.addDoc exists
                if(!modules || !modules.addDoc || !modules.collection) {
                    console.error('Firebase modules missing when trying to add order.', modules);
                    alert('Order saved failed: Firebase not initialized correctly. Contact support.');
                } else {
                    await modules.addDoc(modules.collection(modules.db,'orders'), orderObject);
                }

                // 2. DECREMENT STOCK
                for (const item of cart) {
                    if (item.id) {
                        try {
                            const itemRef = modules.doc(modules.db, 'inventory', item.id);
                            await modules.updateDoc(itemRef, {
                                qty: modules.increment(-item.qty)
                            });
                        } catch (err) {
                            console.error(`Failed to decrement stock for ${item.id}`, err);
                        }
                    }
                }

                alert('Payment successful! Order ID: '+orderId);
                cart=[]; renderCart(); document.getElementById('cartModal').classList.remove('show');
            } catch(e) { console.error(e); alert('Payment successful but order logging failed. Contact support.'); }
        };

        await handlePayment(email, total, orderId, {}, successHandler, btn);
    };

    // --- NEW: Place order without taking payment (manual/admin flow)
    document.getElementById('placeOrderBtn').onclick = async function() {
        const btn = this;
        btn.disabled = true;
        const modules = await firebaseModulesPromise;
        try {
            if(!modules || !modules.auth || !modules.auth.currentUser){ alert('Please Sign In first.'); btn.disabled = false; return; } 
            if(cart.length===0){alert('Cart empty!'); btn.disabled = false; return;}

            const name=document.getElementById('custName').value.trim();
            const phone=document.getElementById('custPhone').value.trim();
            const email=document.getElementById('custEmail').value.trim();
            const total=Number(cartTotal.textContent);

            if(!name||!phone||!email){alert('Please fill all details.'); btn.disabled = false; return;}

            const orderId = generateOrderId("ORD");
            const userId = modules.auth.currentUser.uid;

            const orderObject = {
                orderId,
                userId,
                customerName: name,
                customerPhone: phone,
                customerEmail: email,
                items: cart.map(i => ({ id: i.id || null, name: i.name, price: i.price, qty: i.qty })),
                totalAmount: total,
                status: 'pending',            // important: admin will see this and process
                paid: false,
                transactionId: null,
                reference: null,
                method: 'manual',            // indicates not paid via Paystack
                timestamp: modules.serverTimestamp()
            };

            // write order
            if(!modules || !modules.addDoc || !modules.collection) {
                console.error('Firebase modules missing when trying to add manual order.', modules);
                alert('Order save failed: Firebase not initialized correctly. Contact support.');
                btn.disabled = false;
                return;
            }

            await modules.addDoc(modules.collection(modules.db,'orders'), orderObject);

            // Do NOT decrement stock here automatically for manual orders.
            // If you want stock decremented when you confirm, do it after admin confirms.
            alert('Order placed (pending). Admin will contact you. Order ID: '+orderId);
            cart=[]; renderCart(); document.getElementById('cartModal').classList.remove('show');
        } catch (err) {
            console.error('Manual order save error', err);
            alert('Failed to place order. Check console for details.');
        } finally {
            btn.disabled = false;
        }
    };

    let selectedMTNPrice=6, selectedMTNBundle="1GB";
    document.querySelector('.mtn-bundles button').classList.add('selected');
    document.querySelectorAll('.mtn-bundles button').forEach(btn=>{
      btn.onclick=()=>{
        document.querySelectorAll('.mtn-bundles button').forEach(b=>b.classList.remove('selected'));
        btn.classList.add('selected');
        selectedMTNPrice=Number(btn.dataset.price);
        selectedMTNBundle=btn.textContent.split('‚Äì')[0].trim();
      };
    });
    document.getElementById('mtnOpenBtn').onclick=()=>document.getElementById('mtnModal').classList.add('show');

    document.getElementById('mtnPay').onclick = async function() {
        const btn = this;
        const modules = await firebaseModulesPromise;
        if(!modules || !modules.auth || !modules.auth.currentUser){ alert('Please Sign In first.'); return; } 
        const number=document.getElementById('mtnNumber').value.trim();
        const name=document.getElementById('mtnName').value.trim();
        const email=document.getElementById('mtnEmail').value.trim();
        if(!number||!name||!email){alert('Please fill all details.'); return;}
        if(number.length !== 10){alert('Invalid 10-digit MTN number (e.g., 054xxxxxxx).'); return;}

        const orderId = generateOrderId("MTN");
        const userId = modules.auth.currentUser.uid;

        const successHandler = async (res) => {
            try {
                const orderObject = {
                    orderId,
                    userId,
                    customerName: name,
                    customerPhone: number,
                    customerEmail: email,
                    bundle: selectedMTNBundle,
                    amount: selectedMTNPrice,
                    status: 'Paid',
                    paid: true,
                    transactionId: res.reference || null,
                    reference: res.reference,
                    timestamp: modules.serverTimestamp()
                };

                if(!modules || !modules.addDoc) {
                    console.error('Firebase modules missing when trying to add mtn order.', modules);
                    alert('Bundle purchase logged failed: Firebase not initialized correctly. Contact support.');
                } else {
                    await modules.addDoc(modules.collection(modules.db,'mtn_orders'), orderObject);
                }

                alert('MTN Bundle Purchased! Order ID: '+orderId);
                document.getElementById('mtnModal').classList.remove('show');
            } catch(e) { console.error(e); alert('Payment successful but error logging. Ref: '+res.reference); }
        };

        await handlePayment(email, selectedMTNPrice, orderId, {
            custom_fields: [{display_name:'MTN Number', variable_name:'mtn_number', value:number}]
        }, successHandler, btn);
    };
    
    const orderBtnHandler = document.createElement('button');
    orderBtnHandler.id = 'orderBtn_handler'; orderBtnHandler.style.display = 'none';
    document.body.appendChild(orderBtnHandler);
    orderBtnHandler.onclick = async () => {
        const modules = await firebaseModulesPromise;
        if(!modules || !modules.auth || !modules.auth.currentUser){ alert('Please Sign In first.'); return; }
        if(cart.length===0){alert('Cart empty!'); return;}
        
        let total = 0; let itemsList = '';
        cart.forEach((i, index)=>{
          const subtotal = i.price * i.qty;
          itemsList += `\n*${index + 1}.* ${i.name} (x${i.qty} @ ‚Çµ${i.price} = ‚Çµ${subtotal})`;
          total += subtotal;
        });

        let message=`Hello Luxe Store! Confirming order details.\n\n*Account:* ${modules.auth.currentUser.email}\n*--- ORDER ---*${itemsList}\n\n*TOTAL: ‚Çµ${total}*\n\nPlease provide delivery info.`;
        window.open(`https://wa.me/${CUSTOMER_SERVICE_NUMBER}?text=${encodeURIComponent(message)}`, '_blank');
    };

    // ---- ADMIN: load orders into admin panel (listens to both collections) ----
    async function loadAdminOrders() {
      const modules = await firebaseModulesPromise;
      const container = document.getElementById('adminOrdersContainer');
      if(!modules || !modules.onSnapshot || !modules.collection) {
        container.innerHTML = '<p>Admin tools unavailable. Firebase not initialized.</p>';
        return;
      }

      container.innerHTML = '<p>Listening for orders...</p>';

      // Keep latest snapshots in arrays and render combined
      let ordersDocs = [], mtnDocs = [];

      function renderCombined() {
        const combined = []
          .concat(ordersDocs.map(d => ({...d.data(), _id: d.id, _col: 'orders'})))
          .concat(mtnDocs.map(d => ({...d.data(), _id: d.id, _col: 'mtn_orders'})));
        // sort by timestamp (newest first) if timestamp present
        combined.sort((a,b) => {
          const ta = a.timestamp && a.timestamp.toDate ? a.timestamp.toDate().getTime() : 0;
          const tb = b.timestamp && b.timestamp.toDate ? b.timestamp.toDate().getTime() : 0;
          return tb - ta;
        });

        if(combined.length === 0) { container.innerHTML = '<p>No orders yet.</p>'; return; }

        let html = '<div style="overflow:auto;"><table style="width:100%; border-collapse:collapse; min-width:900px;">';
        html += '<thead><tr style="text-align:left;"><th>Order ID</th><th>Type</th><th>Customer</th><th>Phone</th><th>Items / Bundle</th><th>Qty</th><th>Total (‚Çµ)</th><th>Paid</th><th>Txn ID</th><th>Status</th><th>Time</th><th>Actions</th></tr></thead><tbody>';

        combined.forEach(d => {
          const itemsDesc = d.items ? (d.items || []).map(it => `${it.name} x${it.qty}`).join('<br>') : (d.bundle ? `${d.bundle}` : '');
          const totalQty = d.items ? (d.items || []).reduce((s,it) => s + (it.qty||0), 0) : (d.amount ? 1 : 0);
          const when = d.timestamp && d.timestamp.toDate ? d.timestamp.toDate().toLocaleString() : (d.timestamp ? String(d.timestamp) : 'N/A');
          const paidText = d.paid ? 'Yes' : 'No';
          const txn = d.transactionId || d.reference || '';
          const totalAmount = (d.totalAmount || d.amount || 0);

          const markLabel = (d._col === 'mtn_orders') ? 'Mark Delivered' : 'Mark Shipped';

          html += `<tr style="border-top:1px solid #eaeaea; padding:8px;">
                    <td style="vertical-align:top;">${d.orderId || d._id}</td>
                    <td style="vertical-align:top;">${d._col === 'mtn_orders' ? 'MTN Bundle' : 'Product Order'}</td>
                    <td style="vertical-align:top;">${d.customerName || ''}<br><small>${d.customerEmail||''}</small></td>
                    <td style="vertical-align:top;">${d.customerPhone || ''}</td>
                    <td style="vertical-align:top;">${itemsDesc}</td>
                    <td style="vertical-align:top;">${totalQty}</td>
                    <td style="vertical-align:top;">${totalAmount}</td>
                    <td style="vertical-align:top;">${paidText}</td>
                    <td style="vertical-align:top;">${txn}</td>
                    <td style="vertical-align:top;">${d.status || ''}</td>
                    <td style="vertical-align:top;">${when}</td>
                    <td style="vertical-align:top;">
                      <button data-id="${d._id}" data-col="${d._col}" class="admin-confirm" style="margin-bottom:6px;padding:8px;border-radius:6px;border:none;background:${'#27ae60'};color:white;cursor:pointer;">Confirm & Decrement</button><br>
                      <button data-id="${d._id}" data-col="${d._col}" class="admin-mark" style="margin-top:6px;padding:8px;border-radius:6px;border:none;background:${'#f39c12'};color:white;cursor:pointer;">${markLabel}</button>
                    </td>
                   </tr>`;
        });

        html += '</tbody></table></div>';
        container.innerHTML = html;

        // attach actions
        container.querySelectorAll('.admin-confirm').forEach(btn => {
          btn.onclick = async (e) => {
            const id = btn.dataset.id;
            const col = btn.dataset.col;
            if(!confirm('Confirm this order and decrement inventory (if applicable)?')) return;
            try {
              const orderRef = modules.doc(modules.db, col, id);
              const orderSnap = await modules.getDoc(orderRef);
              if(!orderSnap.exists()) { alert('Order not found.'); return; }
              const orderData = orderSnap.data();

              // Decrement each item if in inventory (skip for MTN orders)
              if(orderData.items && Array.isArray(orderData.items)) {
                for(const it of (orderData.items || [])) {
                  if(it.id) {
                    const invRef = modules.doc(modules.db, 'inventory', it.id);
                    await modules.updateDoc(invRef, { qty: modules.increment(- (it.qty || 0) ) });
                  }
                }
              }

              // Update order status and mark paid if not already (admin confirm implies payment verification)
              const updates = { status: 'confirmed' };
              if(!orderData.paid && orderData.method === 'manual') {
                // keep paid false for manual orders unless you verify externally
              }
              await modules.updateDoc(orderRef, updates);
              alert('Order confirmed (inventory adjusted if applicable).');
            } catch(err) {
              console.error('Admin confirm error', err);
              alert('Failed to confirm order. Check console.');
            }
          };
        });

        container.querySelectorAll('.admin-mark').forEach(btn => {
          btn.onclick = async () => {
            const id = btn.dataset.id;
            const col = btn.dataset.col;
            // For MTN bundles, admin should mark 'delivered'; for other product orders mark 'shipped'
            const newStatus = (col === 'mtn_orders') ? 'delivered' : 'shipped';
            const confirmMsg = (col === 'mtn_orders') ? 'Mark this MTN bundle order as delivered?' : 'Mark this order as shipped/delivered?';
            if(!confirm(confirmMsg)) return;
            try {
              const orderRef = modules.doc(modules.db, col, id);
              await modules.updateDoc(orderRef, { status: newStatus });
              alert(`Order marked as ${newStatus}.`);
            } catch(err) {
              console.error('Admin mark error', err);
              alert('Failed to update status.');
            }
          };
        });

      }

      // snapshot for product orders
      modules.onSnapshot(modules.collection(modules.db, 'orders'), (snapshot) => {
        ordersDocs = snapshot.docs;
        renderCombined();
      }, (err) => { console.error('orders snapshot error', err); container.innerHTML = '<p>Error listening to orders. Check console.</p>'; });

      // snapshot for mtn orders
      modules.onSnapshot(modules.collection(modules.db, 'mtn_orders'), (snapshot) => {
        mtnDocs = snapshot.docs;
        renderCombined();
      }, (err) => { console.error('mtn_orders snapshot error', err); /* don't overwrite earlier error UI */ });

    }

}
</script>
</body>
</html>
